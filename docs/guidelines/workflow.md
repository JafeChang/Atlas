# Claude + Atlas 协作工作流

本文档定义 Claude 在 Atlas 项目中的协作方式，核心目标是：
**减少无效沟通，避免跑偏设计，保持小步可回滚迭代。**

---

## 1. 协作总模型：三类请求

### A. 明确实现型（直接写代码）

特征：
- 功能、输入、输出、触发方式明确
- 不引入新基础设施
- 不涉及合规灰区

Claude 行为：
- 直接输出可合并代码
- 不提问

示例：
- 新增一个公开 RSS 抓取任务
- 增加字段映射规则
- 日志或目录结构重构

---

### B. 架构 / 边界型（先问再写）

特征：
- 会改变系统形态或成本结构
- 引入新组件或长期依赖

Claude 行为：
- 最多提出 3 个关键问题
- 同时给出默认假设与备选路径

示例：
- 引入数据库 / 搜索引擎
- 使用代理池
- 大规模 LLM 抽取

---

### C. 探索 / 不确定型（先方案后骨架）

特征：
- 目标抽象
- 涉及多模块协作

Claude 行为：
- 先给 1 页方案（模块 + 数据流）
- 同时给最小可运行骨架

示例：
- “做一个更通用的数据管道”
- “设计可扩展的 source 插件系统”

---

## 2. Gate 问题清单（强制）

只要命中以下任一项，Claude 必须先问：

1. 是否需要登录、验证码、付费访问
2. 是否引入新的存储 / 索引系统
3. 是否引入 LLM 且频率未知
4. 是否改变运行形态（服务化 / 云端）
5. 是否破坏本地优先原则

---

## 3. Claude 代码交付清单

每次代码输出，必须包含：

- 目标与范围
- 文件变更列表
- 核心实现
- 运行方式
- 回滚方式
- 最小验证方法
- **单元测试覆盖（如有新功能）**

---

## 4. Atlas 推荐迭代里程碑

### Milestone 0：最小闭环
- fetch → normalize → store(raw)
- 无 LLM
- 文件存储

### Milestone 1：结构化与检索
- 规范 schema
- 去重
- 轻量索引

### Milestone 2：智能增强
- LLM 抽取（低频）
- 小模型 / 规则（高频）
- 成本与质量监控

---

## 5. 判定速查表（问 or 写）

| 场景 | Claude 行为 |
|----|----|
| 新增公开 source | 直接写 |
| 新增去重逻辑 | 直接写 |
| 引入 DB / 搜索引擎 | 先问 |
| 使用代理 / 绕反爬 | 先问 |
| LLM 抽取字段 | 先问 |
| 重构目录 / 命名 | 直接写 |
| 做通用插件系统 | 方案 + 骨架 |

---

## 6. 推荐对话模板

### 直接写代码
- 目标：
- 输入：
- 输出：
- 触发方式：
- 约束：

### 允许先问
- 目标：
- 不确定点：
- 可接受默认假设：
- 明确不能做的事：

---

## 7. 单元测试规范

### 7.1 测试优先级

**必须测试：**
- 新增核心功能模块
- 配置管理逻辑
- 数据转换和验证
- 错误处理路径
- 关键业务逻辑

**建议测试：**
- 工具函数
- 数据模型类
- 接口层（CLI、API）

**可选测试：**
- 简单数据访问层
- 第三方库包装器
- 纯展示逻辑

### 7.2 测试文件组织

```
tests/
├── conftest.py              # pytest配置和共享fixtures
├── unit/                    # 单元测试
│   ├── test_config.py       # 配置系统测试
│   ├── test_logging.py      # 日志系统测试
│   ├── test_collectors.py   # 数据采集测试
│   └── test_*.py           # 其他模块测试
├── integration/             # 集成测试
│   └── test_data_pipeline.py # 数据管道集成测试
└── fixtures/               # 测试数据（如有）
```

### 7.3 测试编写标准

**命名规范：**
- 测试文件：`test_<module_name>.py`
- 测试类：`Test<ClassName>`
- 测试方法：`test_<specific_behavior>`

**测试结构（AAA模式）：**
```python
def test_specific_behavior():
    # Arrange - 准备测试数据和环境
    config = Mock()
    collector = Collector(config)

    # Act - 执行被测试的行为
    result = collector.collect(source_config)

    # Assert - 验证结果
    assert len(result) == expected_count
    assert result[0]['title'] == expected_title
```

**Mock使用原则：**
- 隔离外部依赖（网络、文件系统、数据库）
- 测试边界条件（空值、异常、大数据量）
- 验证交互行为（调用次数、参数）

### 7.4 测试运行和CI

**本地运行：**
```bash
# 运行所有测试
pytest

# 运行特定模块测试
pytest tests/unit/test_config.py

# 运行带覆盖率的测试
pytest --cov=src/atlas --cov-report=html

# 运行集成测试
pytest -m integration
```

**测试标记：**
- `@pytest.mark.unit`: 单元测试
- `@pytest.mark.integration`: 集成测试
- `@pytest.mark.slow`: 慢速测试

### 7.5 Claude测试工作流

1. **编写新功能时**：同步编写对应单元测试
2. **修改现有功能时**：更新或增加相关测试
3. **重构代码时**：确保测试覆盖重构路径
4. **交付前检查**：运行相关测试确保通过

### 7.6 测试质量标准

**好的测试特征：**
- 快速执行（单元测试 < 1秒）
- 独立运行（不依赖执行顺序）
- 明确断言（具体的期望值）
- 覆盖边界（正常、异常、边界情况）

**避免的测试反模式：**
- 测试实现细节而非行为
- 过度复杂的Mock设置
- 依赖外部系统状态
- 测试多个不相关的功能

---

## 8. 核心原则

- 一次只推进一小步
- 所有东西可回滚
- 优先可运行，再优雅
- **测试驱动，质量优先**
