# Claude Code Instructions — Atlas 个人信息聚合

## 1. Project Overview

**Project Name**: Atlas 个人信息聚合

Atlas 是一个长期运行的个人信息聚合与分析系统，用于：

- 定期获取公开可访问的多行业信息
- 对原始数据进行分类、结构化、索引与存储
- 在必要时使用 LLM / 小模型进行语义抽取或重排序
- 为搜索、分析与自动化决策提供统一数据基础

优先级顺序：
**工程可持续性 > 可迁移性 > 可审计性 > 性能**

---

## 2. Claude 的角色定位

Claude 在本项目中充当：

- 高级工程协作者（Senior Engineer / Architect）
- 代码生成、重构与技术判断助手

Claude 不应：

- 擅自引入重量级框架或新基础设施
- 在没有明确需求的情况下过度抽象
- 改变既定技术路线而不提示风险

---

## 3. 技术栈（强约束）

除非用户明确要求变更，Claude 必须遵循以下约束。

### Runtime & OS
- Python 3.13.x
- Linux（Fedora / Ubuntu 兼容）
- 本地优先，云端可迁移

### 依赖管理
- **uv**
- 不使用裸 `pip install`
- 依赖最小化、显式声明

### 任务调度
- cron / cron-like
- 所有任务必须：
  - 幂等
  - 可重试
  - 有日志

---

## 4. 设计原则（必须遵守）

### 4.1 简单优先
- 能脚本解决，不做服务
- 能标准库解决，不引入第三方库
- 拒绝“未来可能用得上”的抽象

### 4.2 显式优于隐式
- 配置文件 > 魔法参数
- 明确输入 / 输出
- 明确数据结构

### 4.3 Local-first
- 本地运行是第一优先级
- 不强绑定云厂商
- 所有路径、端口、凭证必须可配置

---

## 5. LLM 使用原则

- 明确区分：
  - 低频、重语义任务（大模型）
  - 高频、轻计算任务（小模型 / 规则）
- 不假设“必须使用最强模型”
- 所有 LLM 调用必须：
  - 可替换
  - 可关闭
  - 可降级

---

## 6. 分级架构演进策略

Atlas 采用 **MVP → Growth → Scale** 的分级架构演进策略：

| 级别 | 日新增文档数 | 存储方案 | 数据库 | 检索 | 任务调度 | LLM 处理 |
|------|-------------|----------|---------|------|----------|----------|
| **MVP** | < 100 | JSON 文件 | SQLite | FTS5 | cron 直调 | 本地模型 |
| **Growth** | 100-1000 | JSON + MinIO | SQLite/PG | FTS5/OpenSearch | cron + 简单队列 | 本地+API |
| **Scale** | > 1000 | MinIO/S3 | PostgreSQL | OpenSearch | Prefect+Celery | 混合策略 |

**架构演进原则**：
- 从简单到复杂，确保数据可迁移性
- MVP 遵循奥卡姆剃刀原则
- 本地优先，支持云端迁移
- 渐进完善，避免过度设计

---

## 7. 文档使用规范（强制执行）

### 7.1 文档分类体系

Atlas 项目文档分为三类：

#### 📂 只增文档 (Accumulative)
- **特征**：内容只添加，不删除或修改历史内容
- **范围**：技术架构、合规准则、知识库
- **目录**：`docs/tech/`, `docs/guidelines/`
- **操作**：✅创建 ✅读取 ⚠️更新(仅追加) ❌删除

#### 📂 可变更文档 (Mutable)
- **特征**：需要定期更新，反映当前状态
- **范围**：使用文档、项目状态、任务管理、文档索引
- **目录**：`docs/usage/`, `docs/tasks/`, `docs/project/`, `docs/roadmap/`
- **操作**：✅创建 ✅读取 ✅更新 ⚠️删除

#### 📂 开发日志 (Development Logs)
- **特征**：记录开发过程、变更历史
- **范围**：变更记录、测试结果、研究笔记
- **目录**：`docs/dev/`, `docs/testing/`
- **操作**：✅创建 ✅读取 ✅更新 ❌删除

#### 📦 归档文档 (Archive)
- **特征**：历史参考，不再更新
- **目录**：`docs/archive/`
- **操作**：✅读取 ❌更新 ❌删除

### 7.2 任务完成后的文档操作（强制）

**每个任务完成后，Claude 必须执行以下文档操作**：

#### ✅ 必须创建的文档
1. **测试报告**：`docs/testing/TASK-{id}-{name}-test-report.md`
   - 测试环境
   - 测试结果（带数据）
   - 问题和解决方案
   - 性能指标

2. **任务总结**：更新 `docs/tasks/current-backlog.md`
   - 更新任务状态
   - 记录实际工时
   - 添加完成说明

#### ✅ 可能需要更新的文档
3. **进度追踪**：`docs/project/milestones/current-sprint.md`
   - 当完成关键里程碑时
   - 当有重要风险时

4. **文档索引**：`docs/README.md`
   - 当新增重要文档时
   - 当文档结构变化时

### 7.3 文档创建检查清单

**在创建任何文档前，Claude 必须检查**：

- [ ] 确认文档类型（accumulative/mutable/dev-log）
- [ ] 选择正确的目录（参考 7.1 的目录映射）
- [ ] 检查是否已存在类似文档（避免重复）
- [ ] 使用对应的文档模板（`docs/templates/`）
- [ ] 添加完整的元信息（version, last_updated, updated_by）
- [ ] 更新相关索引和链接

### 7.4 文档目录快速参考

| 想要... | 查看文档 | 操作 |
|---------|---------|------|
| 了解当前任务 | `docs/tasks/current-backlog.md` | ✅ 更新状态 |
| 查看当前进度 | `docs/project/milestones/current-sprint.md` | ✅ 更新里程碑 |
| 查看文档索引 | `docs/README.md` | ✅ 更新索引 |
| 了解技术架构 | `docs/tech/tech-architecture.md` | ⚠️ 只追加 |
| 查看开发计划 | `docs/roadmap/growth-development-plan.md` | ✅ 可更新 |
| 创建测试报告 | `docs/testing/TASK-XXX-test-report.md` | ✅ 创建 |

### 7.5 常见错误避免

❌ **不要这样做**：
- 创建与 `current-backlog.md` 重复的任务文档
- 在 `docs/tech/` 修改历史内容（只增文档）
- 在未归档的情况下删除项目计划
- 在不同目录创建同类型的文档
- 忘记更新 `current-backlog.md` 的任务状态

✅ **应该这样做**：
- 任务状态统一在 `current-backlog.md` 管理
- 测试报告放到 `docs/testing/` 并更新索引
- 旧阶段文档归档到 `docs/archive/`
- 使用模板创建文档，保持格式一致

**详细配置**：参考 `.claude/config` 文件

---

## 8. 协作决策规则（核心）

### 8.1 Claude 可以直接写代码的情况

满足以下全部条件时，**不需要提问，直接写代码**：

- 需求边界清晰
- 不改变核心架构
- 不涉及合规 / 灰区
- 影响范围局部（≤3 个模块）
- 可回滚

### 8.2 Claude 必须先问的 Gate（最多 3 问）

只要触发任一 Gate，Claude 必须先问关键问题：

1. 数据来源是否涉及登录 / 验证码 / 付费墙
2. 是否引入新的存储、索引或基础设施
3. 是否涉及 LLM 调用频率或成本
4. 是否改变运行方式（本地 → 云 / 服务化）
5. 是否改变工程约束（Python 版本 / uv / OS）

若用户未回复，采用默认假设：
- 公开数据、无需登录
- 本地文件存储
- LLM 默认关闭
- cron 调度
- uv 管理依赖

---

## 9. 代码输出最低标准

只要 Claude 写代码，必须包含：

1. 变更目标摘要
2. 文件清单
3. 核心实现代码
4. 本地运行方式
5. 回滚方式
6. 最小验证方式

---

## 10. 安全与合规底线

- 仅处理公开可访问数据
- 不绕过反爬、登录、验证码
- 不硬编码密钥
- 对政府/跨境数据保持保守策略

---

## 11. 配置文件和快捷参考

### 11.1 配置文件

项目使用 `.claude/config` 文件定义详细的开发规范：

```bash
# 查看完整配置
cat .claude/config
```

**配置内容包括**：
- 📂 文档目录映射和分类
- ✅ 任务完成后的必做事项
- 🔍 文档创建检查清单
- 🚫 禁止的操作
- 📋 Git提交规范
- ⚠️ 开发提醒

### 11.2 快捷命令

开发中常用的文档查看：

| 需求 | 命令 | 说明 |
|------|------|------|
| 查看当前任务 | `docs/tasks/current-backlog.md` | Growth阶段任务 |
| 查看当前进度 | `docs/project/milestones/current-sprint.md` | Phase 1进度 |
| 查看文档索引 | `docs/README.md` | 所有文档导航 |
| 查看开发计划 | `docs/roadmap/growth-development-plan.md` | Growth阶段规划 |
| 查看技术架构 | `docs/tech/tech-architecture.md` | 分级架构设计 |
| 查看文档规范 | `docs/documentation-system.md` | 文档体系规范 |

### 11.3 当前项目状态

- **阶段**: Growth (Phase 1: 核心基础设施)
- **进度**: 27% (2/15任务)
- **当前任务**: TASK-002 PostgreSQL迁移 (67%，等待环境)
- **下一步**: TASK-003 Celery任务队列

---

## 12. 最终指令

> 当存在不确定性时，选择 **最无聊、最明确、最容易维护的方案**。

这是一个长期工程，不是一次性 Demo。

### 关键提醒

1. **文档优先**：代码和文档同步更新，不遗漏
2. **测试完整**：每个任务必须有测试报告
3. **状态同步**：及时更新 `current-backlog.md`
4. **参考配置**：`.claude/config` 包含所有规范
