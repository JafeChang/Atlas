#!/bin/bash
# Git pre-commit hook for Atlas project

set -e

# È¢úËâ≤ÂÆö‰πâ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üîç Running pre-commit checks..."

# Ê£ÄÊü•ÊòØÂê¶Êúâ Python Êñá‰ª∂Ë¢´‰øÆÊîπ
python_files_changed=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$python_files_changed" ]; then
    echo "‚úÖ No Python files changed, skipping Python checks"
    exit 0
fi

# Á°Æ‰øù uv ÂèØÁî®
if ! command -v uv &> /dev/null; then
    if command -v python &> /dev/null && [ -d ".venv" ]; then
        source .venv/bin/activate
        PYTHON_CMD="python"
    else
        echo -e "${RED}‚ùå uv not found and no virtual environment activated${NC}"
        exit 1
    fi
else
    PYTHON_CMD="uv run python"
fi

echo "üìù Python files changed:"
echo "$python_files_changed"
echo ""

# ËøêË°å‰ª£Á†ÅÊ†ºÂºèÂåñÊ£ÄÊü•
echo "üé® Checking code formatting..."
if command -v black &> /dev/null; then
    if ! black --check $python_files_changed; then
        echo -e "${YELLOW}‚ö†Ô∏è Code formatting issues found. Run 'black .' to fix.${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è Black not found, skipping format check${NC}"
fi

# ËøêË°åÂØºÂÖ•ÊéíÂ∫èÊ£ÄÊü•
echo "üìö Checking import sorting..."
if command -v isort &> /dev/null; then
    if ! isort --check-only $python_files_changed; then
        echo -e "${YELLOW}‚ö†Ô∏è Import sorting issues found. Run 'isort .' to fix.${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è isort not found, skipping import sort check${NC}"
fi

# ËøêË°å linting
echo "üîç Running linter..."
if command -v ruff &> /dev/null; then
    if ! ruff check $python_files_changed; then
        echo -e "${RED}‚ùå Linting errors found${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è Ruff not found, skipping linting${NC}"
fi

# ËøêË°åÁ±ªÂûãÊ£ÄÊü•
echo "üè∑Ô∏è Running type checker..."
if command -v mypy &> /dev/null; then
    # Âè™Ê£ÄÊü•‰øÆÊîπÁöÑÊñá‰ª∂
    if ! mypy $python_files_changed; then
        echo -e "${RED}‚ùå Type checking errors found${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è MyPy not found, skipping type checking${NC}"
fi

# ËøêË°åÊµãËØï
echo "üß™ Running tests..."
if command -v pytest &> /dev/null; then
    # Âè™ËøêË°å‰∏é‰øÆÊîπÊñá‰ª∂Áõ∏ÂÖ≥ÁöÑÊµãËØï
    test_files=""
    for file in $python_files_changed; do
        # Â∞Ü src/atlas/file.py ËΩ¨Êç¢‰∏∫ tests/test_file.py
        test_file=$(echo "$file" | sed 's|src/atlas/|tests/test_|' | sed 's|\.py$|_test.py|')
        if [ -f "$test_file" ]; then
            test_files="$test_files $test_file"
        fi
    done

    if [ -n "$test_files" ]; then
        echo "Running tests for: $test_files"
        if ! pytest $test_files -v; then
            echo -e "${RED}‚ùå Tests failed${NC}"
            exit 1
        fi
    else
        echo "No specific tests found for changed files"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è pytest not found, skipping tests${NC}"
fi

# Ê£ÄÊü•ÊñáÊ°£Â≠óÁ¨¶‰∏≤
echo "üìñ Checking docstrings..."
for file in $python_files_changed; do
    # Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞ÂáΩÊï∞Áº∫Â∞ëÊñáÊ°£Â≠óÁ¨¶‰∏≤
    new_functions=$(git diff --cached "$file" | grep '^+' | grep -E '^\+def ' | wc -l)
    if [ "$new_functions" -gt 0 ]; then
        echo -e "${YELLOW}‚ö†Ô∏è New functions found in $file. Please ensure they have proper docstrings.${NC}"
    fi
done

# Ê£ÄÊü•ÈÖçÁΩÆÊñá‰ª∂ËØ≠Ê≥ï
echo "‚öôÔ∏è Checking configuration files..."
config_files_changed=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(yaml|yml)$' || true)

for file in $config_files_changed; do
    if command -v python &> /dev/null; then
        if ! python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
            echo -e "${RED}‚ùå YAML syntax error in $file${NC}"
            exit 1
        fi
    fi
done

echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
exit 0